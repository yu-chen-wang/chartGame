<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" type="text/css" href="styles\reset.css">

    <!-- jquery -->
    <script src="scripts\jquery-3.3.1.min.js" type="text/javascript"></script>

    <!-- 股票圖 -->
    <script src="scripts\highStock\highstock.js"></script>
    <script src="scripts\highStock\modules\exporting.js"></script>
    <script src="scripts\highStock\modules\drag-panes.js"></script>

    <!-- dark theme -->
    <script src="scripts\highStock\themes\dark-unica.js"></script>

    <!-- SMA -->
    <script src="scripts\highStock\indicators\indicators.js"></script>
    <script src="scripts\highStock\indicators\volume-by-price.js"></script>

    <script>

        $(document).ready(function () {

            // 遊戲資料日期 YYYY/MM/DD
            let dataDate = getDataDate();

            // 遊戲資料
            let data = getTickData(dataDate);

            let dateArray = dataDate.split('/');

            // 昨收價日期 YYYYMMDD
            let closePriceDate = dateArray[0] + dateArray[1] + dateArray[2];

            // 昨收價
            let ytdClosePrice = getYtdClosePrice(closePriceDate);

            gameInit(dataDate, data, ytdClosePrice);

            // 取得遊戲資料日期
            // @return 日期 YYYYMMDD
            function getDataDate() {
                let dateIsHoliday = 'true';

                while (dateIsHoliday === 'true') {

                    let date = getRandomDate();
                    let dateArray = date.split('/');
                    let dateCheck = dateArray[0] + dateArray[1] + dateArray[2];

                    dateIsHoliday = checkDate(dateCheck);
                    //console.log("date is holiday:", dateIsHoliday);

                    if (dateIsHoliday === 'false') {
                        return date;
                    }
                }

            }

            // 取得亂數日期 從 2016 ~ 昨天 (當天還沒有期貨資料)
            // @return Date YYYY/MM/DD
            function getRandomDate() {
                let date = new Date();

                // 亂數開始年分
                let yearMin = 2016;

                let yearMax = date.getFullYear();
                let monthMin = 1;
                let monthMax = 12;

                let year = Math.floor(Math.random() * (yearMax - yearMin + 1)) + yearMin;

                if (year == yearMax) {
                    monthMax = date.getMonth();
                }

                let month = Math.floor(Math.random() * (monthMax - monthMin + 1)) + monthMin;

                // 亂數出的月份天數
                let dayMax = new Date(year, month, 0).getDate();
                let dayMin = 1;

                if (month == monthMax) {
                    dayMax--;
                }

                let day = Math.floor(Math.random() * (dayMax - dayMin + 1)) + dayMin;

                if (month < 10) {
                    month = '0' + month;
                }

                if (day < 10) {
                    day = '0' + day;
                }

                let result = year.toString() + '/' + month.toString() + '/' + day.toString();

                return result;
            }

            // 檢查日期是否為假日
            // @param date 要檢查的日期 YYYYMMDD
            // @return true 假日 false 非假日
            function checkDate(date) {
                let result;

                $.ajax({
                    url: 'callApi.php',
                    type: 'GET',
                    async: false,
                    data: { method: 'GET', url: 'http://192.168.10.148/CmMannaWCF/IsHoliday?date8=' + date + '&ck=936DA01F-9ABD-4d9d-80C7-02AF85C822A8', data: false },
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        result = response;
                    }

                })

                return result;
            }

            // 取得期貨資料
            // @param date 欲取得期貨的日期 YYYY/MM/DD
            // @return object 期貨資料
            function getTickData(date) {
                let result;

                $.ajax({
                    url: 'callApi.php',
                    type: 'GET',
                    async: false,
                    data: { method: 'GET', url: 'http://192.168.10.148/TickDbData/api/tick/get?time=' + date, data: false },
                    type: 'GET',
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        let data = JSON.parse(response);
                        result = data;
                    }
                })

                return result;
            }

            // 取得昨天收盤價
            // @param date 取得日期 YYYYMMDD
            // @return 昨收價
            function getYtdClosePrice(date) {

                let result;

                $.ajax({
                    url: 'callApi.php',
                    type: 'GET',
                    async: false,
                    data: { method: 'GET', url: 'http://192.168.10.148/TickDbDataII/api/TWPoint/RefrencePrice/' + date + '?type=json', data: false },
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        result = response;
                    }
                })

                return result;
            }



        });


    </script>

    <title>對戰</title>
</head>

<body>

    <div id="gameChart" style="width:100%; height:600px;"></div>


    <script>




        // 創建遊戲圖表
        // @param dataDate 遊戲資料日期
        // @param data 遊戲資料
        // @param ytdClosePrice 昨天收盤價
        function gameInit(dataDate, data, ytdClosePrice) {

            console.log("date:", dataDate);
            console.log("data:", data);
            console.log('昨收價:', ytdClosePrice);

            // dateDate = "2018/09/07";
            // ytdClosePrice = 10900;

            // 資料
            let ohlc = new Array();

            // 成交量
            let totalQty = new Array();

            // 成交量顏色
            let qtyColor = '';

            let date = new Date();

            let time;

            let lastPrMax = data.KChartTickList[0].LastPr;
            let lastPrMin = data.KChartTickList[0].LastPr;

            // 轉換時區
            let timezoneSet = Math.abs(date.getTimezoneOffset() / 60) * 60 * 60 * 1000;


            for (let i = 0; i < data.KChartTickList.length; i++) {

                // if (i < 15) {
                //     pushData();
                // }

                // if (i == 15) {
                //     setInterval(pushData, 5000);
                // }

                // function pushData() {
                    // 最高收盤價
                    if (data.KChartTickList[i].LastPr > lastPrMax) {
                        lastPrMax = data.KChartTickList[i].LastPr;
                    }

                    // 最低收盤價
                    if (data.KChartTickList[i].LastPr < lastPrMin) {
                        lastPrMin = data.KChartTickList[i].LastPr;
                    }

                    time = data.KChartTickList[i].kTickTime;

                    ohlc.push([
                        new Date(time).getTime() + timezoneSet,     // 時間
                        data.KChartTickList[i].OpenPr,              // 開盤價
                        data.KChartTickList[i].HighPr,              // 最高價
                        data.KChartTickList[i].LowPr,               // 最低價
                        data.KChartTickList[i].LastPr               // 收盤價
                    ]);

                    let isHigher = data.KChartTickList[i].OpenPr > data.KChartTickList[i].LastPr;
                    let isSame = data.KChartTickList[i].OpenPr == data.KChartTickList[i].LastPr;

                    // 漲
                    if (isHigher) {
                        qtyColor = '#FF0000';
                    }
                    // 跌
                    else {
                        qtyColor = '#00DD00';
                    }
                    // 開盤 == 收盤
                    if (isSame) {
                        qtyColor = '#888888';
                    }

                    totalQty.push({
                        x: new Date(time).getTime() + timezoneSet, // 時間
                        y: data.KChartTickList[i].TotalQty,        // 成交量
                        color: qtyColor
                    });



                    // console.log(ohlc);
                    //  console.log(totalQty);

                // }


            }

            // create the chart
            let chart = Highcharts.stockChart('gameChart', {

                chart: {
                    events: {
                        load: function () {
                            // set up the updating of the chart each second
                            setInterval(function () {

                                // chart.series[1].setData(totalQty);
                            }, 1000);
                        }
                    }
                },

                rangeSelector: {
                    selected: 1
                },

                rangeSelector: {
                    enabled: false
                },

                // navigator: {
                //     enabled: false
                // },

                // title: {
                //     text: 'AAPL Historical'
                // },

                legend: {
                    enabled: true,
                    // layout: 'vertical',
                    align: 'left',
                    verticalAlign: 'top',
                    floating: true,
                    // backgroundColor: '#FFFFFF'
                },

                plotOptions: {
                    candlestick: {
                        color: '#FF0000',
                        upColor: '#00DD00'
                    },
                },

                xAxis: {
                    labels: {
                        enabled: false
                    },
                    range: 6 * 30 * 24 * 400
                },

                yAxis: [{
                    // y軸 max
                    max: lastPrMax + 15,

                    // y軸 min
                    min: lastPrMin - 15,

                    labels: {
                        align: 'right',
                        x: -3,
                        enabled: false
                    },
                    title: {
                        text: '分K',
                        rotation: 0,
                        enabled: false
                    },
                    height: '80%',
                    lineWidth: 2,
                    resize: {
                        enabled: true
                    },
                    plotLines: [{
                        color: '#00BBFF',
                        value: ytdClosePrice,
                        width: 2
                    }],
                }, {
                    labels: {
                        align: 'right',
                        x: -3,
                        // enabled: false
                    },
                    title: {
                        text: '成交量',
                        rotation: 0,
                        enabled: false
                    },
                    top: '85%',
                    height: '15%',
                    offset: 0,
                    lineWidth: 1
                }],

                tooltip: {
                    split: true,
                    // enabled: false
                },

                series: [{
                    type: 'candlestick',
                    name: '分K',
                    id: 'ohlc',
                    data: ohlc,
                    showInLegend: false,
                    pointRange: 100000,
                    // pointWidth: 50,
                    gapSize: 20
                    // dataGrouping: {
                    //     units: groupingUnits
                    // }
                }, {
                    type: 'column',
                    name: '成交量',
                    data: totalQty,
                    yAxis: 1,
                    showInLegend: false,
                    pointRange: 100000,
                    // pointWidth: 50,
                    // dataGrouping: {
                    //     units: groupingUnits
                    // }
                }, {
                    name: "5MA",
                    linkedTo: "ohlc",
                    showInLegend: true,
                    color: "#FFBB00",
                    // dashStyle: "ShortDashDotDot",
                    type: "sma",
                    algorithm: "SMA",
                    params: {
                        period: 5
                    }
                }],
                exporting: {
                    buttons: {
                        buyButton: {
                            x: 0,
                            y: 330,
                            onclick: function () {
                                alert('買');
                            },
                            text: '買'
                        },
                        sellButton: {
                            x: 0,
                            y: 300,
                            onclick: function () {
                                alert('賣');
                            },
                            text: '賣'
                        }
                    }
                }


            });


        }

            // data = {
            //     KChartTickList: [
            //         {
            //             kTickTime: "2018-12-22T08:45:00",
            //             HighPr: 10814,
            //             LastPr: 10810,
            //             LowPr: 10808,
            //             OpenPr: 10809,
            //             TotalQty: 1152
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:46:00",
            //             HighPr: 10812,
            //             LastPr: 10807,
            //             LowPr: 10803,
            //             OpenPr: 10810,
            //             TotalQty: 669
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:47:00",
            //             HighPr: 10810,
            //             LastPr: 10806,
            //             LowPr: 10805,
            //             OpenPr: 10807
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:48:00",
            //             HighPr: 10814,
            //             LastPr: 10810,
            //             LowPr: 10808,
            //             OpenPr: 10809,
            //             TotalQty: 1152
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:49:00",
            //             HighPr: 10812,
            //             LastPr: 10807,
            //             LowPr: 10803,
            //             OpenPr: 10810,
            //             TotalQty: 669
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:50:00",
            //             HighPr: 10810,
            //             LastPr: 10806,
            //             LowPr: 10805,
            //             OpenPr: 10807
            //         },{
            //             kTickTime: "2018-12-22T08:51:00",
            //             HighPr: 10814,
            //             LastPr: 10810,
            //             LowPr: 10808,
            //             OpenPr: 10809,
            //             TotalQty: 1152
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:52:00",
            //             HighPr: 10812,
            //             LastPr: 10807,
            //             LowPr: 10803,
            //             OpenPr: 10810,
            //             TotalQty: 669
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:53:00",
            //             HighPr: 10810,
            //             LastPr: 10806,
            //             LowPr: 10805,
            //             OpenPr: 10807
            //         },{
            //             kTickTime: "2018-12-22T08:54:00",
            //             HighPr: 10814,
            //             LastPr: 10810,
            //             LowPr: 10808,
            //             OpenPr: 10809,
            //             TotalQty: 1152
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:55:00",
            //             HighPr: 10812,
            //             LastPr: 10807,
            //             LowPr: 10803,
            //             OpenPr: 10810,
            //             TotalQty: 669
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:56:00",
            //             HighPr: 10810,
            //             LastPr: 10806,
            //             LowPr: 10805,
            //             OpenPr: 10807
            //         },{
            //             kTickTime: "2018-12-22T08:57:00",
            //             HighPr: 10814,
            //             LastPr: 10810,
            //             LowPr: 10808,
            //             OpenPr: 10809,
            //             TotalQty: 1152
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:58:00",
            //             HighPr: 10812,
            //             LastPr: 10807,
            //             LowPr: 10803,
            //             OpenPr: 10810,
            //             TotalQty: 669
            //         },
            //         {
            //             kTickTime: "2018-12-22T08:59:00",
            //             HighPr: 10810,
            //             LastPr: 10806,
            //             LowPr: 10805,
            //             OpenPr: 10807
            //         },{
            //             kTickTime: "2018-12-22T09:00:00",
            //             HighPr: 10814,
            //             LastPr: 10810,
            //             LowPr: 10808,
            //             OpenPr: 10809,
            //             TotalQty: 1152
            //         },
            //         {
            //             kTickTime: "2018-12-22T09:01:00",
            //             HighPr: 10812,
            //             LastPr: 10807,
            //             LowPr: 10803,
            //             OpenPr: 10810,
            //             TotalQty: 669
            //         },
            //         {
            //             kTickTime: "2018-12-22T09:02:00",
            //             HighPr: 10810,
            //             LastPr: 10806,
            //             LowPr: 10805,
            //             OpenPr: 10807
            //         },{
            //             kTickTime: "2018-12-22T09:03:00",
            //             HighPr: 10814,
            //             LastPr: 10810,
            //             LowPr: 10808,
            //             OpenPr: 10809,
            //             TotalQty: 1152
            //         },
            //         {
            //             kTickTime: "2018-12-22T09:04:00",
            //             HighPr: 10812,
            //             LastPr: 10807,
            //             LowPr: 10803,
            //             OpenPr: 10810,
            //             TotalQty: 669
            //         },
            //         {
            //             kTickTime: "2018-12-22T09:05:00",
            //             HighPr: 10810,
            //             LastPr: 10806,
            //             LowPr: 10805,
            //             OpenPr: 10807
            //         },{
            //             kTickTime: "2018-12-22T09:06:00",
            //             HighPr: 10814,
            //             LastPr: 10810,
            //             LowPr: 10808,
            //             OpenPr: 10809,
            //             TotalQty: 1152
            //         },
            //         {
            //             kTickTime: "2018-12-22T09:07:00",
            //             HighPr: 10812,
            //             LastPr: 10807,
            //             LowPr: 10803,
            //             OpenPr: 10810,
            //             TotalQty: 669
            //         },
            //         {
            //             kTickTime: "2018-12-22T09:08:00",
            //             HighPr: 10810,
            //             LastPr: 10806,
            //             LowPr: 10805,
            //             OpenPr: 10807
            //         },{
            //             kTickTime: "2018-12-22T09:09:00",
            //             HighPr: 10814,
            //             LastPr: 10810,
            //             LowPr: 10808,
            //             OpenPr: 10809,
            //             TotalQty: 1152
            //         },
            //         {
            //             kTickTime: "2018-12-22T09:10:00",
            //             HighPr: 10812,
            //             LastPr: 10807,
            //             LowPr: 10803,
            //             OpenPr: 10810,
            //             TotalQty: 669
            //         },
            //         {
            //             kTickTime: "2018-12-22T09:11:00",
            //             HighPr: 10810,
            //             LastPr: 10806,
            //             LowPr: 10805,
            //             OpenPr: 10807
            //         },
            //     ]
            // };


    </script>



</body>

</html>