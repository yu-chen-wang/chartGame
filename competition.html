<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>對戰</title>

    <!-- jquery -->
    <script src="scripts\jquery-3.3.1.min.js" type="text/javascript"></script>

    <!-- cookie function -->
    <script src="scripts\cookie.js" type="text/javascript"></script>

    <!-- 股票圖 -->
    <script src="scripts\highStock\highstock.js"></script>
    <script src="scripts\highStock\modules\exporting.js"></script>
    <script src="scripts\highStock\modules\drag-panes.js"></script>

    <!-- dark theme -->
    <script src="scripts\highStock\themes\dark-unica.js"></script>

    <!-- SMA -->
    <script src="scripts\highStock\indicators\indicators.js"></script>
    <script src="scripts\highStock\indicators\volume-by-price.js"></script>

    <script>

        $(document).ready(function () {

            // 遊戲資料日期 YYYY/MM/DD
            let dataDate = getDataDate();

            // 遊戲資料
            let data = getTickData(dataDate);

            let dateArray = dataDate.split('/');

            // 昨收價日期 YYYYMMDD
            let closePriceDate = dateArray[0] + dateArray[1] + dateArray[2];

            // 昨收價
            let ytdClosePrice = getYtdClosePrice(closePriceDate);


            // 取得遊戲資料日期
            // @return 日期 YYYYMMDD
            function getDataDate() {
                let dateIsHoliday = 'true';

                while (dateIsHoliday === 'true') {

                    let date = getRandomDate();
                    let dateArray = date.split('/');
                    let dateCheck = dateArray[0] + dateArray[1] + dateArray[2];

                    dateIsHoliday = checkDate(dateCheck);
                    //console.log("date is holiday:", dateIsHoliday);

                    // 不是假日
                    if (dateIsHoliday === 'false') {
                        return date;
                    }
                }

            }

            // 取得亂數日期 從 2012 ~ 去年
            // @return Date YYYY/MM/DD
            function getRandomDate() {
                let date = new Date();

                // 亂數開始年分
                let yearMin = 2012;

                let yearMax = date.getFullYear() - 1;
                let monthMin = 1;
                let monthMax = 12;

                let year = Math.floor(Math.random() * (yearMax - yearMin + 1)) + yearMin;

                if (year == yearMax) {
                    monthMax = date.getMonth();
                }

                let month = Math.floor(Math.random() * (monthMax - monthMin + 1)) + monthMin;

                // 亂數出的月份天數
                let dayMax = new Date(year, month, 0).getDate();

                let dayMin = 1;

                if (month == monthMax) {
                    dayMax--;
                }

                let day = Math.floor(Math.random() * (dayMax - dayMin + 1)) + dayMin;

                if (month < 10) {
                    month = '0' + month;
                }

                if (day < 10) {
                    day = '0' + day;
                }

                let result = year.toString() + '/' + month.toString() + '/' + day.toString();

                return result;
            }

            // 檢查日期是否為假日
            // @param date 要檢查的日期 YYYYMMDD
            // @return true 假日 false 非假日
            function checkDate(date) {
                let result;

                $.ajax({
                    url: 'callApi.php',
                    type: 'GET',
                    async: false,
                    data: { method: 'GET', url: 'http://192.168.10.148/CmMannaWCF/IsHoliday?date8=' + date + '&ck=936DA01F-9ABD-4d9d-80C7-02AF85C822A8', data: false },
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        result = response;
                    }

                })

                return result;
            }

            // 取得期貨資料
            // @param date 欲取得期貨的日期 YYYY/MM/DD
            // @return result 期貨資料
            function getTickData(date) {
                let result;

                $.ajax({
                    url: 'callApi.php',
                    type: 'GET',
                    async: false,
                    data: { method: 'GET', url: 'http://192.168.10.148/TickDbData/api/tick/get?time=' + date, data: false },
                    type: 'GET',
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        let data = JSON.parse(response);
                        result = data;
                    }
                })

                return result;
            }

            // 取得昨天收盤價
            // @param date 取得日期 YYYYMMDD
            // @return 昨收價
            function getYtdClosePrice(date) {

                let result;

                $.ajax({
                    url: 'callApi.php',
                    type: 'GET',
                    async: false,
                    data: { method: 'GET', url: 'http://192.168.10.148/TickDbDataII/api/TWPoint/RefrencePrice/' + date + '?type=json', data: false },
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        result = response;
                    }
                })

                return result;
            }


            let gameChart;

            let p1Status = {
                lot: 0,         // 持有口數
                Profit: 0,      // 及時損益(未成交)
                lastTick: 0     // 最近買賣的 tick
            }

            let p2Status = {
                lot: 0,
                Profit: 0,
                lastTick: 0
            }

            // p1 及時損益
            let p1Profit = 0;

            // p2 及時損益
            let p2Profit = 0;

            // p1 ID
            let p1ID = parseInt(getCookie("playerID"));

            // p2 ID
            let p2ID = 666;

            // 取得 p1 Image
            let p1ImagePath = getCookie("imagePath");
            $("#p1Img").attr("src", p1ImagePath);

            // p1 圖片 用於買賣 Icon
            let p1Image = "url(" + p1ImagePath + ")";

            // 機器人圖片
            let p2Image = "url(http://www.cmoney.tw/follow/images/head-icons/a24.gif)";

            // 取得 p1 NickName
            let p1NickName = getCookie("nickName");
            $("#p1Name").text(p1NickName);

            // 玩家1 交易紀錄
            let p1TradeDetail = initPlayer(p1ID);

            // 玩家2 交易紀錄
            let p2TradeDetail = initPlayer(p2ID);

            // 存放交易當下的座標 x = time, y = lastPr
            let tradeIcon = [];

            // 開始準備秒數
            let startCountDown = 3;

            // 遊戲倒數秒數
            let countDown = 100;

            // 紀錄價格漲跌 AI 買賣判斷依據
            let priceCount = 0;

            // 創建 player
            // @param PlayerID
            // return player
            function initPlayer(playerID) {
                let player = {
                    GameID: 0,
                    PlayerID: playerID,
                    TradeHistory: [],
                    tradeResult: {
                        GameID: 0,
                        PlayerID: playerID,
                        GainMoneySum: 0,
                        LossMoneySum: 0,
                        GainLotSum: 0,
                        LossLotSum: 0,
                        OLotSum: 0,
                        MaxAheadMoney: 0,
                        MaxBehindMoney: 0,
                        MaxGainLotMoney: 0,
                        MaxLossLotMoney: 0
                    }
                }

                return player;
            }

            // 按下返回按鈕
            $("#backBtn").click(function () {
                let check = confirm("確定要退出遊戲嗎？");
                if (check == true) {
                    window.location = "lobby.html";
                }
                else {
                    // console.log("否");
                }
            });

            console.log("date:", dataDate);
            console.log("data:", data);
            console.log('昨收價:', ytdClosePrice);

            // 遊戲紀錄
            let gameDetail = initGameDetail();

            gameDetail.P1PlayerID = p1TradeDetail.tradeResult.PlayerID;
            gameDetail.P2PlayerID = p2TradeDetail.tradeResult.PlayerID;

            // 取得 GameID
            // let gameID = parseInt(getGameID(JSON.stringify(gameDetail)));
            gameID = 12345;
            console.log("gameID:", gameID);

            p1TradeDetail.GameID = gameID;
            p1TradeDetail.tradeResult.GameID = gameID;

            p2TradeDetail.GameID = gameID;
            p2TradeDetail.tradeResult.GameID = gameID;

            // 創建遊戲資訊
            // return gameDetail
            function initGameDetail() {

                let d = new Date();

                let timezoneSet = Math.abs(d.getTimezoneOffset() / 60) * 60 * 60 * 1000;
                let now = new Date(d.getTime() + timezoneSet).toISOString();

                let gameDetail = {
                    GameMode: 1,
                    GameDate: now,
                    TradeDate: dataDate,
                    P1PlayerID: 0,
                    P2PlayerID: 0,
                    P1Profit: 0,
                    P2Profit: 0,
                    GameSpeed: 1,
                    GameFee: 0,
                    GameMaxLot: 1,
                    HasP1Finish: false,
                    HasP2Finish: false
                }

                return gameDetail;
            }

            // 上傳 GameDetail 並取得 GameID
            function getGameID(gameDetail) {
                let result;

                $.ajax({
                    url: 'callChartApi.php',
                    type: 'POST',
                    async: false,
                    data: { method: 'POST', url: 'http://192.168.10.148/ChartGame/api/GameInfo/InsertGameDetail', data: gameDetail },
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        // console.log("response", response);
                        result = response;
                    }

                })

                return result;
            }

            $("#sellBtn").prop("disabled", true);
            $("#buyBtn").prop("disabled", true);

            // 遊戲準備倒數
            let startThread = setInterval(function () {
                startCountDown--;
                $("#startCountDown").text("準備 " + startCountDown);

                // 遊戲開始
                if (startCountDown == 0) {
                    clearInterval(startThread);

                    $("#startCountDown").remove();

                    $("#sellBtn").prop("disabled", false);
                    $("#buyBtn").prop("disabled", false);

                    // 遊戲倒數
                    let countDownThread = setInterval(function () {

                        countDown--;
                        $('#countDown').text(countDown);

                        if (countDown == 0) {
                            clearInterval(countDownThread);
                        }

                    }, 1000);
                }

            }, 1000);


            // 資料
            let ohlc = new Array();

            // 成交量
            let totalQty = new Array();

            // 成交量顏色
            let qtyColor = '';

            let date = new Date();

            // 每筆資料時間
            let time;

            // 最高價
            let lastPrMax = data.KChartTickList[0].HighPr;

            // 最低價
            let lastPrMin = data.KChartTickList[0].LowPr;

            // 轉換時區
            let timezoneSet = Math.abs(date.getTimezoneOffset() / 60) * 60 * 60 * 1000;

            // x軸最小值
            let minXaxis = new Date(data.KChartTickList[0].kTickTime).getTime();

            // x軸最大值 
            let maxXaxis = new Date(data.KChartTickList[0].kTickTime).getTime() + 1140000;


            // 遊戲開始前先載入20筆資料 並計算最大值和最小值
            for (let i = 0; i < 125; i++) {

                // 最高價
                if (data.KChartTickList[i].HighPr > lastPrMax) {
                    lastPrMax = data.KChartTickList[i].HighPr;
                }

                // 最低價
                if (data.KChartTickList[i].LowPr < lastPrMin) {
                    lastPrMin = data.KChartTickList[i].LowPr;
                }

                if (i < 20) {
                    time = data.KChartTickList[i].kTickTime;

                    ohlc.push([
                        new Date(time).getTime(),     // 時間
                        data.KChartTickList[i].OpenPr,              // 開盤價
                        data.KChartTickList[i].HighPr,              // 最高價
                        data.KChartTickList[i].LowPr,               // 最低價
                        data.KChartTickList[i].LastPr               // 收盤價
                    ]);

                    // 收盤價 - 開盤價
                    let price = data.KChartTickList[i].LastPr - data.KChartTickList[i].OpenPr;

                    // 漲
                    if (price > 0) {
                        qtyColor = '#FF0000';
                    }
                    // 跌
                    else if (price < 0) {
                        qtyColor = '#00DD00';
                    }
                    // 開盤 == 收盤
                    else {
                        qtyColor = '#888888';
                    }

                    // 成交量
                    totalQty.push({
                        x: new Date(time).getTime(),               // 時間
                        y: data.KChartTickList[i].TotalQty,        // 成交量
                        color: qtyColor
                    });
                }

            }

            // 開始 timeTick
            let i = 19;

            // 遊戲開始 每秒新增一筆資料
            let gameThread = setInterval(function () {

                // 開始等待 3秒
                if (startCountDown == 0) {

                    i++;

                    // 遊戲結束
                    if (countDown == 0) {
                        clearInterval(gameThread);
                    }
                    else {
                        time = data.KChartTickList[i].kTickTime;

                        ohlc.push([
                            new Date(time).getTime(),                 // 時間
                            data.KChartTickList[i].OpenPr,            // 開盤價
                            data.KChartTickList[i].HighPr,            // 最高價
                            data.KChartTickList[i].LowPr,             // 最低價
                            data.KChartTickList[i].LastPr             // 收盤價
                        ]);

                        // 收盤價 - 開盤價
                        let price = data.KChartTickList[i].LastPr - data.KChartTickList[i].OpenPr;

                        priceCount = 0;

                        // 漲
                        if (price > 0) {
                            qtyColor = '#FF0000';

                            priceCount++;
                            if (data.KChartTickList[i - 1].LastPr > data.KChartTickList[i - 1].OpenPr) {
                                priceCount++;
                            }

                            if (priceCount == 2 && p2Status.lot >= 0 && p2Status.lot <= 1 && i > 20) {

                                // AI 賣
                                sell({ data: "p2" });
                                priceCount = 0;
                            }
                        }

                        // 跌
                        else if (price < 0) {
                            qtyColor = '#00DD00';

                            priceCount--;
                            if (data.KChartTickList[i - 1].LastPr < data.KChartTickList[i - 1].OpenPr) {
                                priceCount--;
                            }

                            if (priceCount == -2 && p2Status.lot >= -1 && p2Status.lot <= 0 && i > 20) {

                                // AI 買
                                buy({ data: "p2" });
                                priceCount = 0;
                            }
                        }

                        // 開盤 == 收盤
                        else {
                            qtyColor = '#888888';
                        }

                        totalQty.push({
                            x: new Date(time).getTime(), // 時間
                            y: data.KChartTickList[i].TotalQty,        // 成交量
                            color: qtyColor
                        });
                    }

                }

            }, 1000);


            // 按下賣按鈕
            $("#sellBtn").click("p1", sell);

            // 按下買按鈕
            $("#buyBtn").click("p1", buy);

            // 按下賣按鈕
            // @param player "p1" or "p2"
            function sell(player) {
                let playerStatus;
                let playerTrade;

                // player1
                if (player.data == "p1") {
                    tradeIcon.push({
                        x: ohlc[i + 1][0],
                        y: ohlc[i + 1][2] + 8,
                        marker: {
                            symbol: p1Image,
                            width: 35,
                            height: 35
                        }
                    });

                    playerStatus = p1Status;
                    playerTrade = p1TradeDetail;

                    playerStatus.lot -= 1;
                    $("#p1Lot").text(playerStatus.lot);

                    // 先買再賣
                    if (playerStatus.lot == 0) {
                        $("#buyBtn").prop('disabled', false);
                        setTrade("sell", "p1");
                    }

                    if (playerStatus.lot == -1) {
                        $("#sellBtn").prop('disabled', true);
                    }
                }

                // player2
                else {
                    tradeIcon.push({
                        x: ohlc[i + 1][0],
                        y: ohlc[i + 1][2] + 12,
                        marker: {
                            symbol: p2Image,
                            width: 35,
                            height: 35
                        }
                    });


                    playerStatus = p2Status;
                    playerTrade = p2TradeDetail;

                    playerStatus.lot -= 1;
                    $("#p2Lot").text(playerStatus.lot);

                    // 先買再賣
                    if (playerStatus.lot == 0) {
                        setTrade("sell", "p2");
                    }

                }

                gameChart.series[2].setData(tradeIcon);


                playerTrade.TradeHistory.push(
                    {
                        GameID: gameID,
                        PlayerID: playerTrade.tradeResult.PlayerID,
                        TradeTick: i,
                        TradeAmount: -1
                    }
                )

                playerStatus.lastTick = i;

            }

            // 按下買按鈕
            // @param player "p1" or "p2"
            function buy(player) {
                let playerStatus;
                let playerTrade;

                // player1
                if (player.data == "p1") {
                    tradeIcon.push({
                        x: ohlc[i + 1][0],
                        y: ohlc[i + 1][3] - 8,
                        marker: {
                            symbol: p1Image,
                            width: 35,
                            height: 35
                        }
                    });

                    playerStatus = p1Status;
                    playerTrade = p1TradeDetail;

                    playerStatus.lot += 1;
                    $("#p1Lot").text(playerStatus.lot);

                    // 先賣再買
                    if (playerStatus.lot == 0) {
                        $("#sellBtn").prop('disabled', false);
                        setTrade("buy", "p1");
                    }

                    if (playerStatus.lot == 1) {
                        $("#buyBtn").prop('disabled', true);
                    }
                }

                // player2
                else {
                    tradeIcon.push({
                        x: ohlc[i + 1][0],
                        y: ohlc[i + 1][3] - 12,
                        marker: {
                            symbol: p2Image,
                            width: 35,
                            height: 35
                        }
                    });

                    playerStatus = p2Status;
                    playerTrade = p2TradeDetail;

                    playerStatus.lot += 1;
                    $("#p2Lot").text(playerStatus.lot);

                    // 先賣再買
                    if (playerStatus.lot == 0) {
                        setTrade("buy", "p2");
                    }

                }

                gameChart.series[2].setData(tradeIcon);


                playerTrade.TradeHistory.push(
                    {
                        GameID: gameID,
                        PlayerID: playerTrade.tradeResult.PlayerID,
                        TradeTick: i,
                        TradeAmount: 1
                    }
                )

                playerStatus.lastTick = i;

            }


            // 處理交易損益
            // @param trade "sell" or "buy" 按下買或賣按鈕
            // @param player 玩家 "p1" or "p2"
            function setTrade(trade, player) {

                let playerStatus;
                let playerTrade;

                if (player == "p1") {
                    playerStatus = p1Status;
                    playerTrade = p1TradeDetail;
                }
                else {
                    playerStatus = p2Status;
                    playerTrade = p2TradeDetail;
                }

                // 上一筆 買/賣 位置
                let lastTick = playerStatus.lastTick;

                let deal;

                if (trade == "sell") {
                    deal = data.KChartTickList[i].LastPr - data.KChartTickList[lastTick].LastPr;
                }
                else {
                    deal = data.KChartTickList[lastTick].LastPr - data.KChartTickList[i].LastPr;
                }

                // console.log("deal:", deal);

                playerStatus.Profit += deal;

                // 賺
                if (deal > 0) {

                    // 獲利口數
                    playerTrade.tradeResult.GainLotSum++;

                    // 總獲利
                    playerTrade.tradeResult.GainMoneySum += deal;

                    // 單口賺最多
                    if (deal > playerTrade.tradeResult.MaxGainLotMoney) {
                        playerTrade.tradeResult.MaxGainLotMoney = deal;
                    }

                }

                // 賠
                else if (deal < 0) {

                    // 負債口數
                    playerTrade.tradeResult.LossLotSum++;

                    // 總負債
                    playerTrade.tradeResult.LossMoneySum += Math.abs(deal);

                    // 單口賠最多
                    if (Math.abs(deal) > playerTrade.tradeResult.MaxLossLotMoney) {
                        playerTrade.tradeResult.MaxLossLotMoney = Math.abs(deal);
                    }

                }

                // 買 = 賣
                else {
                    playerTrade.tradeResult.OLotSum++;
                }
            }


            // 遊戲結束後更新雙方損益
            function updateBothProfit(bothProfit) {
                $.ajax({
                    url: 'callChartApi.php',
                    type: 'POST',
                    async: false,
                    data: { method: 'POST', url: 'http://192.168.10.148/ChartGame/api/GameInfo/UpdateBothProfit', data: bothProfit },
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        // console.log("response", response);
                    }
                })
            }

            // 遊戲結束後上傳玩家交易紀錄
            function updateTradeDetail(tradeDetail) {
                $.ajax({
                    url: 'callChartApi.php',
                    type: 'POST',
                    async: false,
                    data: { method: 'POST', url: 'http://192.168.10.148/ChartGame/api/GameInfo/UpdateTradeDetail', data: tradeDetail },
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        // console.log("response", response);
                    }
                })
            }

            // create the chart
            gameChart = Highcharts.stockChart('gameChart', {

                chart: {
                    events: {
                        load: function () {
                            // 每秒更新圖表
                            let chartInterval = setInterval(function () {

                                if (startCountDown == 0) {
                                    gameChart.series[0].setData(ohlc);
                                    gameChart.series[0].update({
                                        data: ohlc
                                    })

                                    gameChart.series[1].setData(totalQty);
                                    gameChart.series[1].update({
                                        data: totalQty
                                    })


                                    // 圖表 X軸長度
                                    let chartXaxisLength = 21;

                                    let xEnd = ohlc.length;
                                    let xStart = xEnd - chartXaxisLength;

                                    // 調整圖表 x軸 頭尾
                                    gameChart.xAxis[0].setExtremes(ohlc[xStart][0], ohlc[xEnd - 1][0]);

                                    // 計算 P1 及時累積損益(未完成交易) 先賣再買
                                    if (p1Status.lot == -1) {
                                        p1Profit = p1Status.Profit + data.KChartTickList[p1Status.lastTick].LastPr - data.KChartTickList[i].LastPr;
                                        $("#p1Profit").text(p1Profit);
                                    }

                                    // 計算 P1 及時累積損益(未完成交易) 先買再賣
                                    if (p1Status.lot == 1) {
                                        p1Profit = p1Status.Profit + data.KChartTickList[i].LastPr - data.KChartTickList[p1Status.lastTick].LastPr;
                                        $("#p1Profit").text(p1Profit);
                                    }

                                    // P2 及時累積損益 先賣再買
                                    if (p2Status.lot == -1) {
                                        p2Profit = p2Status.Profit + data.KChartTickList[p2Status.lastTick].LastPr - data.KChartTickList[i].LastPr;
                                        $("#p2Profit").text(p2Profit);
                                    }

                                    // P2 及時累積損益 先買再賣
                                    if (p2Status.lot == 1) {
                                        p2Profit = p2Status.Profit + data.KChartTickList[i].LastPr - data.KChartTickList[p2Status.lastTick].LastPr;
                                        $("#p2Profit").text(p2Profit);
                                    }

                                    // 計算領先的玩家
                                    let profitLead = p1Profit - p2Profit;

                                    if (profitLead > 0) {
                                        // p1 領先最多
                                        if (profitLead > p1TradeDetail.tradeResult.MaxAheadMoney) {
                                            p1TradeDetail.tradeResult.MaxAheadMoney = profitLead;
                                        }

                                        // p2 最大落後
                                        if (profitLead > p2TradeDetail.tradeResult.MaxBehindMoney) {
                                            p2TradeDetail.tradeResult.MaxBehindMoney = profitLead;
                                        }

                                        $("#gameStatus").text("領先  " + profitLead + " 點");
                                    }
                                    else if (profitLead < 0) {
                                        // p1 最大落後
                                        if (Math.abs(profitLead) > p1TradeDetail.tradeResult.MaxBehindMoney) {
                                            p1TradeDetail.tradeResult.MaxBehindMoney = Math.abs(profitLead);
                                        }

                                        // p2 領先最多
                                        if (Math.abs(profitLead) > p2TradeDetail.tradeResult.MaxAheadMoney) {
                                            p2TradeDetail.tradeResult.MaxAheadMoney = Math.abs(profitLead);
                                        }

                                        $("#gameStatus").text("落後  " + Math.abs(profitLead) + " 點");
                                    }
                                    else {
                                        $("#gameStatus").text("平手");
                                    }


                                    // 遊戲結束
                                    if (countDown == 0) {
                                        console.log("遊戲結束");

                                        $("#buyBtn").prop("disabled", true);
                                        $("#sellBtn").prop("disabled", true);

                                        // p1 先買還沒賣
                                        if (p1Status.lot == 1) {

                                            setTrade("sell", "p1");

                                            $("#p1Profit").text(p1Status.Profit);

                                            p1TradeDetail.TradeHistory.push(
                                                {
                                                    GameID: gameID,
                                                    PlayerID: p1TradeDetail.tradeResult.PlayerID,
                                                    TradeTick: i,
                                                    TradeAmount: -1
                                                }
                                            )
                                        }

                                        // p1 先賣還沒買
                                        if (p1Status.lot == -1) {

                                            setTrade("buy", "p1");

                                            $("#p1Profit").text(p1Status.Profit);

                                            p1TradeDetail.TradeHistory.push(
                                                {
                                                    GameID: gameID,
                                                    PlayerID: p1TradeDetail.tradeResult.PlayerID,
                                                    TradeTick: i,
                                                    TradeAmount: 1
                                                }
                                            )
                                        }

                                        // p2 先買還沒賣
                                        if (p2Status.lot == 1) {

                                            setTrade("sell", "p2");

                                            $("#p2Profit").text(p2Status.Profit);

                                            p2TradeDetail.TradeHistory.push(
                                                {
                                                    GameID: 0,
                                                    PlayerID: p2TradeDetail.tradeResult.PlayerID,
                                                    TradeTick: i,
                                                    TradeAmount: -1
                                                }
                                            )
                                        }

                                        // p2 先賣還沒買
                                        if (p2Status.lot == -1) {

                                            setTrade("buy", "p2");

                                            $("#p2Profit").text(p2Status.Profit);

                                            p2TradeDetail.TradeHistory.push(
                                                {
                                                    GameID: gameID,
                                                    PlayerID: p2TradeDetail.tradeResult.PlayerID,
                                                    TradeTick: i,
                                                    TradeAmount: 1
                                                }
                                            )
                                        }

                                        // 更新 GameDetail
                                        let bothProfit = {
                                            GameID: gameID,
                                            P1Profit: p1Status.Profit,
                                            P2Profit: p2Status.Profit,
                                            HasP1Finish: true,
                                            HasP2Finish: true
                                        }


                                        console.log(bothProfit);
                                        console.log("p1 status:", p1Status);
                                        console.log("p1 trade:", p1TradeDetail);
                                        console.log("p2 status:", p2Status);
                                        console.log("p2 trade:", p2TradeDetail);

                                        // 更新 GameDetail
                                        // updateBothProfit(JSON.stringify(bothProfit));

                                        // // 上傳雙方 TradeDetail
                                        // updateTradeDetail(JSON.stringify(p1TradeDetail));
                                        // updateTradeDetail(JSON.stringify(p2TradeDetail));

                                        // setCookie("gameID", gameID, 1);

                                        // 跳轉到遊戲結果頁
                                        // window.location = "gameFinish.html";

                                        clearInterval(chartInterval);
                                    }
                                }

                            }, 1000);
                        }
                    }
                },

                rangeSelector: {
                    selected: 1,
                    enabled: false
                },

                navigator: {
                    enabled: false
                },

                legend: {
                    enabled: true,
                    align: 'left',
                    verticalAlign: 'top',
                    floating: true,
                    // backgroundColor: '#FFFFFF'
                },

                plotOptions: {
                    candlestick: {
                        color: '#00DD00',
                        upColor: '#FF0000'
                    },
                },

                xAxis: {
                    labels: {
                        enabled: false
                    },
                    // min: minXaxis,
                    // max: maxXaxis,
                },

                yAxis: [{
                    // y軸 max
                    max: lastPrMax + 20,

                    // y軸 min
                    min: lastPrMin - 20,

                    labels: {
                        align: 'right',
                        x: -3,
                        enabled: false
                    },
                    title: {
                        text: '分K',
                        rotation: 0,
                        enabled: false
                    },
                    height: '80%',
                    lineWidth: 2,
                    resize: {
                        enabled: true
                    },
                    plotLines: [{
                        color: '#00BBFF',
                        value: ytdClosePrice,
                        width: 2,
                    }],
                }, {
                    labels: {
                        align: 'right',
                        x: -3,
                        enabled: false
                    },
                    title: {
                        text: '成交量',
                        rotation: 0,
                        enabled: false
                    },
                    top: '85%',
                    height: '15%',
                    offset: 0,
                    lineWidth: 1
                }],

                tooltip: {
                    split: true,
                    enabled: false
                },

                series: [{
                    type: 'candlestick',
                    name: '分K',
                    id: 'ohlc',
                    data: ohlc,
                    showInLegend: false,
                    pointRange: 100000,
                    // pointWidth: 50,
                    gapSize: 20,
                    marker: {
                        enabled: false
                    }
                }, {
                    type: 'column',
                    name: '成交量',
                    data: totalQty,
                    yAxis: 1,
                    showInLegend: false,
                    pointRange: 100000,
                    // pointWidth: 50,
                    marker: {
                        enabled: false
                    }
                }, {
                    type: 'scatter',
                    name: 'tradeIcon',
                    data: tradeIcon,
                    showInLegend: false,
                    pointRange: 100000,
                    // pointWidth: 50,
                    // dataLabels: {
                    //     enabled: true
                    // }
                }, {
                    name: "5MA",
                    linkedTo: "ohlc",
                    showInLegend: true,
                    color: "#FFBB00",
                    type: "sma",
                    algorithm: "SMA",
                    params: {
                        period: 5
                    },
                    marker: {
                        enabled: false
                    }
                }],
                exporting: {
                    buttons: {
                        contextButton: {
                            enabled: false
                        },
                    }
                }

            });





        });


    </script>


</head>

<body>

    <!-- 遊戲資訊 -->
    <div id="gameInfo" style="width:100%; height: 300px">
        <input id="backBtn" type="button" value="返回">
        <br>

        <p id="startCountDown" style="font-size:28px; margin: auto">準備 3</p>
        <br>

        <div>
            <span id="gameStatus"> 平手</span>
        </div>
        <br>

        <div>
            <img id="p1Img" style="width:100px; height:100px"></img>
            <p id="p1Name"></p>
            <p>累積損益 <span id="p1Profit"> 0 </span>點</p>
            <p>持有部位 <span id="p1Lot"> 0 </span></p>
        </div>
        <br>

        <div>
            <img src="http://www.cmoney.tw/follow/images/head-icons/a24.gif" style="width:100px; height:100px" id="p2Img"></img>
            <p id="p2Name">賭神機器人</p>
            <p>累積損益 <span id="p2Profit"> 0 </span>點</p>
            <p>持有部位 <span id="p2Lot"> 0 </span></p>
        </div>
        <br>

        <span>倒數</span>
        <span id="countDown" style="font-size:20px">100</span>
        <span>秒</span>
        <br>
        <br>

        <input id="sellBtn" type="button" value="賣">
        <input id="buyBtn" type="button" value="買">


    </div>

    <!-- 遊戲圖表 -->
    <div id="gameChart" style="width:80%; height:600px; margin: auto"></div>


    <script>



    </script>



</body>

</html>