<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- <link rel="stylesheet" type="text/css" href="styles\reset.css"> -->

    <!-- jquery -->
    <script src="scripts\jquery-3.3.1.min.js" type="text/javascript"></script>

    <!-- jquery md5 -->
    <script src="scripts\jQuery.md5.js" type="text/javascript"></script>

    <!-- cookie function -->
    <script src="scripts\cookie.js" type="text/javascript"></script>

    <script>

        $(document).ready(function () {

            let playerID = getCookie("playerID");
            console.log("playerID:", playerID);

            let account;
            let password;

            account = getCookie("account");
            password = getCookie("password");

            // 如果 cookie 有帳號
            if (account.length > 0) {
                $("#account").val(account);
            }

            // 如果 cookie 有密碼
            if (password.length > 0) {
                $("#password").val(password);
            }

            // 按下記住密碼按鈕
            $("#rememberBtn").click(function () {
                $("#isRemember").each(function () {
                    $(this).prop('checked', !$(this)[0].checked);
                })
            });

            $("#login").click(function () {
                account = $("#account").val();
                password = $("#password").val();

                password = $.md5(password);

                // 登入 API 資料
                let loginData = {
                    Action: 'getloginguid',
                    Account: account,
                    token: 'text',
                    Password: password,
                    Appid: 20,
                    Device: 2,
                    isNeedPush: false
                }

                let guid = getGuid(loginData);

                // 取得會員資訊 API 資料
                let memberData = {
                    Action: 'getmemberprofile',
                    Guid: guid
                }

                let userProfile = getUserinfo(memberData);

                let nickName = userProfile.NickName;
                let imagePath = userProfile.ImagePath;

                // 取得 PlayerID API 資料
                let user = {
                    GUID: guid,
                    NickName: nickName,
                    ImagePath: imagePath
                }

                playerID = getPlayerID(JSON.stringify(user));

                if (playerID != -1) {
                    console.log("登入成功:", playerID);
                    setCookie("playerID", playerID, 7);
                    setCookie("nickName", nickName, 7);
                    setCookie("imagePath", imagePath, 7);

                    // 記住帳號密碼
                    if ($("#isRemember").prop("checked")) {
                        setCookie("account", account, 7);
                        setCookie("password", $("#password").val(), 7);
                    }
                    // 不記住帳號密碼
                    else {
                        setCookie("account", "", 0);
                        setCookie("password", "", 0);
                    }

                    window.location = "lobby.html";

                } else {
                    alert("帳號密碼錯誤");
                }

            })

            // 取得會員 guid
            // return guid
            function getGuid(data) {
                let result;

                $.ajax({
                    url: 'callApi.php',
                    type: 'POST',
                    async: false,
                    data: { method: 'POST', url: 'http://www.cmoney.tw/MobileService/ashx/LoginCheck/LoginCheck.ashx', data: data },
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        // console.log("response:", response);
                        result = JSON.parse(response).Guid;
                    }

                })

                return result;
            }

            // 取得會員資訊
            // return memberProfile
            function getUserinfo(data) {
                let result;

                $.ajax({
                    url: 'callApi.php',
                    type: 'POST',
                    async: false,
                    data: { method: 'POST', url: 'http://www.cmoney.tw/MobileService/ashx/LoginCheck/LoginCheck.ashx', data: data },
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        // console.log("response:", response);
                        result = JSON.parse(response);
                    }

                })

                return result;
            }

            // 取得 PlayerID
            // return PlayerID
            function getPlayerID(user) {
                let result;

                $.ajax({
                    url: 'callChartApi.php',
                    type: 'POST',
                    async: false,
                    data: { method: 'POST', url: 'http://192.168.10.148/ChartGame/api/UserInfo/UpdateOrCreateUser', data: user },
                    error: function (error) {
                        console.log(error);
                    },
                    success: function (response) {
                        // console.log("response", response);
                        result = response;
                    }
                })

                return result;
            }


        });


    </script>


    <title>登入</title>
</head>

<body>

    <p>CMoney</p>
    <p>王牌操盤手</p>

    帳號 <input type="email" id="account" required><br>
    密碼 <input type="password" id="password" required><br>

    <input type="button" value="註冊"> <input type="button" value="忘記密碼"> <input type="checkbox" id="isRemember">
    <input type="button" id="rememberBtn" value="記住密碼"><br>

    <input type="button" id="login" value="登入">

</body>

</html>